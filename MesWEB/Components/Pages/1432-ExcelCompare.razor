@page "/excel-compare"
@rendermode InteractiveServer

@using ClosedXML.Excel
@using MesWEB.Models
@using MesWEB.Data
@using Microsoft.EntityFrameworkCore
@inject ILogger<ExcelCompare> Logger
@inject AppDbContext Db

<PageTitle>Excel �V�[�g��r</PageTitle>

<style>
    .comparison-result {
    margin-top: 2rem;
    }

    .result-match {
        background-color: #d4edda;
        color: #155724;
    }

    .result-mismatch {
        background-color: #f8d7da;
        color: #721c24;
    }

    .mapping-section {
      background-color: #f8f9fa;
   padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

  .template-section {
      background-color: #e7f3ff;
 padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .file-list {
      background-color: #fff3cd;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .mapping-row {
        background-color: white;
    padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        margin-bottom: 0.5rem;
    }

    .file-name-input {
        border-left: 3px solid #0d6efd;
    }
</style>

<h3>Excel�V�[�g��r�c�[���i�t�@�C�����x�[�X�j</h3>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">�g����</h5>
        <ol>
   <li><strong>�e���v���[�g���ɓǂݍ��߂܂�</strong> - �t�@�C���A�b�v���[�h�O�ł�OK</li>
            <li>������Excel�t�@�C�����A�b�v���[�h���܂��i�ő�5�t�@�C���A������j</li>
     <li>�Z���Ή��\�Ńt�@�C�����A�V�[�g���A�Z���A�h���X���w�肵�܂�</li>
 <li>�u��r���s�v�{�^�����N���b�N���܂�</li>
  </ol>
        <div class="alert alert-info">
       <i class="fas fa-info-circle"></i> <strong>�e���v���[�g�̓t�@�C�����ƃV�[�g���ŕۑ�����܂��B</strong><br/>
   �u�b�N�̃A�b�v���[�h�����Ɋ֌W�Ȃ��A�����t�@�C����������Ύ����I�Ɋ��蓖�Ă��܂��B
        </div>
    </div>
</div>

<!-- �e���v���[�g�Ǘ� -->
<div class="template-section">
    <h4>�e���v���[�g�Ǘ�</h4>
    
    <div class="row mb-3">
        <div class="col-md-4">
     <label class="form-label">�ۑ����ꂽ�e���v���[�g</label>
            <select @bind="selectedTemplateId" class="form-select">
                <option value="0">-- �e���v���[�g��I�� --</option>
                @foreach (var template in savedTemplates)
        {
     <option value="@template.TemplateId">@template.TemplateName</option>
              }
 </select>
        </div>
      <div class="col-md-8 d-flex align-items-end gap-2">
            <button type="button" class="btn btn-primary" @onclick="LoadTemplate" disabled="@(selectedTemplateId == 0)">
          <i class="fas fa-folder-open"></i> �ǂݍ���
          </button>
   <button type="button" class="btn btn-danger" @onclick="DeleteTemplate" disabled="@(selectedTemplateId == 0)">
    <i class="fas fa-trash"></i> �폜
       </button>
        </div>
    </div>

 <div class="row mb-2">
        <div class="col-md-4">
            <input type="text" @bind="newTemplateName" class="form-control" placeholder="�V�����e���v���[�g��" />
        </div>
        <div class="col-md-6">
     <input type="text" @bind="newTemplateDescription" class="form-control" placeholder="�����i�C�Ӂj" />
        </div>
      <div class="col-md-2">
       <button type="button" class="btn btn-success" @onclick="SaveTemplate" disabled="@(cellMappings.Count == 0)">
       <i class="fas fa-save"></i> @(string.IsNullOrWhiteSpace(newTemplateName) && selectedTemplateId > 0 ? "�㏑��" : "�ۑ�")
  </button>
 </div>
    </div>

    @if (!string.IsNullOrEmpty(templateMessage))
    {
    <div class="alert alert-info mt-2">@templateMessage</div>
    }
</div>

<!-- �t�@�C���A�b�v���[�h -->
<div class="mb-3">
    <label for="fileUpload" class="form-label">Excel�t�@�C����I���i�����A������A�b�v���[�h�j</label>
    <InputFile id="fileUpload" OnChange="HandleFileUpload" class="form-control" accept=".xlsx,.xls" multiple />
<small class="form-text text-muted">�ő�5�t�@�C���܂ŁA�e10MB�B������ɕ����ăA�b�v���[�h�\</small>
</div>

@if (uploadedBooks.Any())
{
    <div class="file-list">
        <h5>�A�b�v���[�h�ς݃t�@�C�� (@uploadedBooks.Count / 5)</h5>
        <ul>
            @foreach (var book in uploadedBooks)
            {
         <li>
 <strong>@book.FileName</strong>
    <small class="text-muted">(@book.Workbook.Worksheets.Count �V�[�g)</small>
      <button type="button" class="btn btn-sm btn-outline-danger ms-2" @onclick="() => RemoveUploadedFile(book.FileName)">
     <i class="fas fa-times"></i>
        </button>
         </li>
      }
        </ul>
    <button type="button" class="btn btn-warning btn-sm" @onclick="ClearUploadedFiles">
          <i class="fas fa-times"></i> �S�ăN���A
 </button>
    </div>
}

<!-- �Z���Ή��\�̐ݒ� -->
<div class="mapping-section">
  <h4>�Z���Ή��\�̐ݒ�</h4>
    
    @for (int i = 0; i < cellMappings.Count; i++)
{
        var index = i;
        <div class="mapping-row">
      <div class="row g-2 align-items-center mb-2">
          <div class="col-12">
     <label class="form-label fw-bold mb-1">���ږ�</label>
     <input type="text" @bind="cellMappings[index].ItemName" class="form-control" placeholder="��: �����琬��" />
                </div>
       </div>

      <div class="row g-2 align-items-center">
       <!-- �u�b�N1 -->
     <div class="col-md-6">
       <div class="border-start border-primary border-3 ps-2">
<label class="form-label mb-1 text-primary"><strong>�u�b�N1</strong></label>
      <div class="row g-2">
    <div class="col-12">
        <label class="form-label small mb-1">�t�@�C�����i����͂܂��̓h���b�v�_�E������I���j</label>
    <input type="text" 
     @bind="cellMappings[index].Book1FileName" 
             @bind:after="() => UpdateBookIndexFromFileName(index, 1)"
           class="form-control form-control-sm file-name-input mb-2" 
                placeholder="��: �񍐏�_A.xlsx"
          list="@($"book-list-{index}-1")" />
    <datalist id="@($"book-list-{index}-1")">
          @foreach (var book in uploadedBooks)
          {
       <option value="@book.FileName">@book.FileName</option>
      }
           </datalist>
       </div>
        <div class="col-12">
       <label class="form-label small mb-1">�V�[�g��I��</label>
            <select @bind="cellMappings[index].Sheet1Name" 
   class="form-select form-select-sm"
     disabled="@(cellMappings[index].Book1Index < 0)">
  <option value="">-- �V�[�g��I�� --</option>
  @if (cellMappings[index].Book1Index >= 0 && cellMappings[index].Book1Index < uploadedBooks.Count)
     {
     @foreach (var sheet in uploadedBooks[cellMappings[index].Book1Index].Workbook.Worksheets)
           {
            <option value="@sheet.Name">@sheet.Name</option>
           }
  }
           </select>
               @if (cellMappings[index].Book1Index < 0 && !string.IsNullOrEmpty(cellMappings[index].Book1FileName))
           {
   <small class="text-warning">? �t�@�C���u@cellMappings[index].Book1FileName�v��������܂���</small>
  }
            </div>
      <div class="col-12">
        <label class="form-label small mb-1">�Z���A�h���X</label>
              <input type="text" @bind="cellMappings[index].Sheet1Cell" 
class="form-control form-control-sm" 
   placeholder="��: A1" />
            </div>
  </div>
       </div>
   </div>

             <!-- �u�b�N2 -->
            <div class="col-md-6">
      <div class="border-start border-success border-3 ps-2">
 <label class="form-label mb-1 text-success"><strong>�u�b�N2</strong></label>
    <div class="row g-2">
   <div class="col-12">
                 <label class="form-label small mb-1">�t�@�C�����i����͂܂��̓h���b�v�_�E������I���j</label>
        <input type="text" 
                @bind="cellMappings[index].Book2FileName" 
          @bind:after="() => UpdateBookIndexFromFileName(index, 2)"
        class="form-control form-control-sm file-name-input mb-2" 
             placeholder="��: �񍐏�_B.xlsx"
           list="@($"book-list-{index}-2")" />
     <datalist id="@($"book-list-{index}-2")">
        @foreach (var book in uploadedBooks)
         {
   <option value="@book.FileName">@book.FileName</option>
     }
          </datalist>
      </div>
        <div class="col-12">
        <label class="form-label small mb-1">�V�[�g��I��</label>
        <select @bind="cellMappings[index].Sheet2Name" 
      class="form-select form-select-sm"
        disabled="@(cellMappings[index].Book2Index < 0)">
   <option value="">-- �V�[�g��I�� --</option>
         @if (cellMappings[index].Book2Index >= 0 && cellMappings[index].Book2Index < uploadedBooks.Count)
               {
   @foreach (var sheet in uploadedBooks[cellMappings[index].Book2Index].Workbook.Worksheets)
             {
         <option value="@sheet.Name">@sheet.Name</option>
       }
         }
    </select>
  @if (cellMappings[index].Book2Index < 0 && !string.IsNullOrEmpty(cellMappings[index].Book2FileName))
 {
    <small class="text-warning">? �t�@�C���u@cellMappings[index].Book2FileName�v��������܂���</small>
           }
 </div>
   <div class="col-12">
    <label class="form-label small mb-1">�Z���A�h���X</label>
     <input type="text" @bind="cellMappings[index].Sheet2Cell" 
         class="form-control form-control-sm" 
  placeholder="��: B5" />
       </div>
       </div>
       </div>
  </div>
  </div>

      <div class="row mt-2">
    <div class="col-12 text-end">
    <button type="button" class="btn btn-danger btn-sm" @onclick="() => RemoveMapping(index)">
           <i class="fas fa-trash"></i> ���̍��ڂ��폜
            </button>
                </div>
            </div>
        </div>
    }

    <div class="d-flex gap-2 mt-3">
   <button type="button" class="btn btn-success" @onclick="AddMapping">
       <i class="fas fa-plus"></i> �Ή��Z����ǉ�
        </button>
        <button type="button" class="btn btn-secondary" @onclick="ClearMappings">
<i class="fas fa-eraser"></i> �N���A
        </button>
        <button type="button" class="btn btn-primary" @onclick="CompareFiles" disabled="@(!CanCompare())">
       <i class="fas fa-search"></i> ��r���s
        </button>
    </div>
</div>

@if (isLoading)
{
    <div class="alert alert-info">
     <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        ������...
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
      <strong>�G���[:</strong> @errorMessage
    </div>
}

<!-- ��r���� -->
@if (comparisonResults != null && comparisonResults.Any())
{
    <div class="comparison-result">
        <h4>��r����</h4>
        
        <div class="mb-3">
    <span class="badge bg-success">��v: @comparisonResults.Count(r => r.IsMatch)</span>
            <span class="badge bg-danger ms-2">�s��v: @comparisonResults.Count(r => !r.IsMatch)</span>
        </div>

        <table class="table table-bordered table-sm">
     <thead>
      <tr>
       <th>���ږ�</th>
        <th>�u�b�N1</th>
          <th>�Z��1</th>
          <th>�l1</th>
         <th>�u�b�N2</th>
        <th>�Z��2</th>
       <th>�l2</th>
          <th>����</th>
         </tr>
        </thead>
            <tbody>
  @foreach (var result in comparisonResults)
      {
         <tr class="@(result.IsMatch ? "result-match" : "result-mismatch")">
        <td>@result.ItemName</td>
  <td><small>@result.Book1Name</small></td>
  <td>@result.Sheet1Cell</td>
           <td>@result.Sheet1Value</td>
            <td><small>@result.Book2Name</small></td>
     <td>@result.Sheet2Cell</td>
     <td>@result.Sheet2Value</td>
        <td>
           @if (result.IsMatch)
             {
 <i class="fas fa-check-circle text-success"></i><text> ��v</text>
          }
            else
        {
        <i class="fas fa-times-circle text-danger"></i><text> �s��v</text>
    }
   @if (!string.IsNullOrEmpty(result.Message))
            {
               <br /><small>@result.Message</small>
            }
    </td>
     </tr>
        }
            </tbody>
        </table>
    </div>
}

@code {
    private class UploadedBook
    {
  public string FileName { get; set; } = string.Empty;
        public XLWorkbook Workbook { get; set; } = null!;
    }

    private List<CellMapping> cellMappings = new();
    private List<CellComparisonResult>? comparisonResults;
    private List<UploadedBook> uploadedBooks = new();
    private bool isLoading = false;
    private string errorMessage = string.Empty;

    // �e���v���[�g�֘A
    private List<CellMappingTemplate> savedTemplates = new();
    private int selectedTemplateId = 0;
    private string newTemplateName = string.Empty;
    private string newTemplateDescription = string.Empty;
    private string templateMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
    await LoadSavedTemplates();
    }

    private async Task LoadSavedTemplates()
    {
        savedTemplates = await Db.CellMappingTemplates
            .Include(t => t.MappingItems)
 .OrderBy(t => t.TemplateName)
    .ToListAsync();
 }

    // �t�@�C��������u�b�N�C���f�b�N�X���X�V�i�����I�ɂ̂ݎg�p�j
    private void UpdateBookIndexFromFileName(int mappingIndex, int bookNumber)
    {
        if (mappingIndex < 0 || mappingIndex >= cellMappings.Count)
          return;

    var mapping = cellMappings[mappingIndex];

        if (bookNumber == 1)
        {
   mapping.Book1Index = uploadedBooks.FindIndex(b => b.FileName == mapping.Book1FileName);
      }
        else if (bookNumber == 2)
{
       mapping.Book2Index = uploadedBooks.FindIndex(b => b.FileName == mapping.Book2FileName);
        }

        StateHasChanged();
    }

    // �S�}�b�s���O�̃u�b�N�C���f�b�N�X���X�V
    private void UpdateAllBookIndices()
    {
        foreach (var mapping in cellMappings)
        {
       mapping.Book1Index = uploadedBooks.FindIndex(b => b.FileName == mapping.Book1FileName);
   mapping.Book2Index = uploadedBooks.FindIndex(b => b.FileName == mapping.Book2FileName);
        }
    }

 private bool CanCompare()
    {
     if (cellMappings.Count == 0) return false;
        
        return cellMappings.All(m =>
          !string.IsNullOrWhiteSpace(m.Book1FileName) &&
            !string.IsNullOrWhiteSpace(m.Sheet1Name) &&
            !string.IsNullOrWhiteSpace(m.Sheet1Cell) &&
            !string.IsNullOrWhiteSpace(m.Book2FileName) &&
  !string.IsNullOrWhiteSpace(m.Sheet2Name) &&
          !string.IsNullOrWhiteSpace(m.Sheet2Cell) &&
    m.Book1Index >= 0 &&
            m.Book2Index >= 0
        );
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        isLoading = true;
     errorMessage = string.Empty;
        comparisonResults = null;

        try
        {
var remainingSlots = 5 - uploadedBooks.Count;
            if (remainingSlots <= 0)
       {
         errorMessage = "����5�t�@�C�����A�b�v���[�h����Ă��܂��B�t�@�C�����폜���Ă���ǉ����Ă��������B";
         return;
            }

            var files = e.GetMultipleFiles(remainingSlots);
     var newFilesCount = 0;

            foreach (var file in files)
       {
   if (file.Size > 10 * 1024 * 1024)
    {
    errorMessage = $"�t�@�C���u{file.Name}�v���傫�����܂��i�ő�10MB�j";
         continue;
   }

     if (uploadedBooks.Any(b => b.FileName == file.Name))
          {
        errorMessage = $"�t�@�C���u{file.Name}�v�͊��ɃA�b�v���[�h����Ă��܂�";
      continue;
       }

     using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
        using var memoryStream = new MemoryStream();
 await stream.CopyToAsync(memoryStream);
      memoryStream.Position = 0;

     var workbook = new XLWorkbook(memoryStream);
    uploadedBooks.Add(new UploadedBook
                {
 FileName = file.Name,
        Workbook = workbook
        });

        newFilesCount++;
                Logger.LogInformation($"�t�@�C���ǂݍ��ݐ���: {file.Name}");
   }

            if (newFilesCount > 0)
            {
         templateMessage = $"{newFilesCount}�̃t�@�C����ǉ����܂����i���v{uploadedBooks.Count}�j";

                // �t�@�C���A�b�v���[�h��A�S�}�b�s���O�̃C���f�b�N�X���X�V
          UpdateAllBookIndices();

         if (cellMappings.Count == 0)
            {
 AddMapping();
       }
            }
     }
      catch (Exception ex)
        {
     errorMessage = $"�t�@�C���ǂݍ��݃G���[: {ex.Message}";
    Logger.LogError(ex, "�t�@�C���A�b�v���[�h�G���[");
   }
        finally
    {
            isLoading = false;
     }
    }

  private void RemoveUploadedFile(string fileName)
{
      var book = uploadedBooks.FirstOrDefault(b => b.FileName == fileName);
        if (book != null)
  {
            book.Workbook?.Dispose();
            uploadedBooks.Remove(book);

         templateMessage = $"�t�@�C���u{fileName}�v���폜���܂����i�c��{uploadedBooks.Count}�j";

          // �S�}�b�s���O�̃C���f�b�N�X���Čv�Z
            UpdateAllBookIndices();
        }
    }

    private void ClearUploadedFiles()
    {
        foreach (var book in uploadedBooks)
        {
            book.Workbook?.Dispose();
        }
        uploadedBooks.Clear();
        comparisonResults = null;
      
        // �C���f�b�N�X�����Z�b�g�i�t�@�C�����͕ێ��j
        foreach (var mapping in cellMappings)
     {
            mapping.Book1Index = -1;
            mapping.Book2Index = -1;
 }
        
templateMessage = "�S�Ẵt�@�C�����N���A���܂���";
    }

    private void CompareFiles()
  {
        isLoading = true;
        errorMessage = string.Empty;
   comparisonResults = new List<CellComparisonResult>();

        try
     {
foreach (var mapping in cellMappings)
            {
           var result = new CellComparisonResult
    {
          ItemName = mapping.ItemName
           };

try
       {
           if (mapping.Book1Index < 0 || mapping.Book1Index >= uploadedBooks.Count)
        {
      result.Message = $"�t�@�C���u{mapping.Book1FileName}�v��������܂���";
          result.IsMatch = false;
     comparisonResults.Add(result);
         continue;
           }

      var book1 = uploadedBooks[mapping.Book1Index];
    result.Book1Name = book1.FileName;

   if (string.IsNullOrWhiteSpace(mapping.Sheet1Name))
  {
           result.Message = "�V�[�g1���I������Ă��܂���";
      result.IsMatch = false;
   comparisonResults.Add(result);
         continue;
}

             if (!book1.Workbook.Worksheets.TryGetWorksheet(mapping.Sheet1Name, out var sheet1))
            {
       result.Message = $"�t�@�C���u{book1.FileName}�v�ɃV�[�g'{mapping.Sheet1Name}'��������܂���";
           result.IsMatch = false;
         comparisonResults.Add(result);
     continue;
          }

       if (mapping.Book2Index < 0 || mapping.Book2Index >= uploadedBooks.Count)
              {
         result.Message = $"�t�@�C���u{mapping.Book2FileName}�v��������܂���";
      result.IsMatch = false;
      comparisonResults.Add(result);
    continue;
        }

    var book2 = uploadedBooks[mapping.Book2Index];
      result.Book2Name = book2.FileName;

     if (string.IsNullOrWhiteSpace(mapping.Sheet2Name))
           {
     result.Message = "�V�[�g2���I������Ă��܂���";
         result.IsMatch = false;
          comparisonResults.Add(result);
       continue;
     }

        if (!book2.Workbook.Worksheets.TryGetWorksheet(mapping.Sheet2Name, out var sheet2))
         {
        result.Message = $"�t�@�C���u{book2.FileName}�v�ɃV�[�g'{mapping.Sheet2Name}'��������܂���";
     result.IsMatch = false;
        comparisonResults.Add(result);
               continue;
         }

      var cell1 = sheet1.Cell(mapping.Sheet1Cell);
           var cell2 = sheet2.Cell(mapping.Sheet2Cell);

   result.Sheet1Cell = $"{mapping.Sheet1Name}!{mapping.Sheet1Cell}";
          result.Sheet1Value = cell1.GetString();
         result.Sheet2Cell = $"{mapping.Sheet2Name}!{mapping.Sheet2Cell}";
        result.Sheet2Value = cell2.GetString();

          result.IsMatch = string.Equals(
    result.Sheet1Value?.Trim(),
            result.Sheet2Value?.Trim(),
        StringComparison.OrdinalIgnoreCase
        );

 if (!result.IsMatch)
          {
           result.Message = "�l����v���܂���";
        }
        }
        catch (Exception ex)
     {
    result.Message = $"�G���[: {ex.Message}";
         result.IsMatch = false;
             Logger.LogError(ex, $"�Z����r�G���[: {mapping.ItemName}");
          }

     comparisonResults.Add(result);
            }

   Logger.LogInformation($"��r����: {comparisonResults.Count}��");
     }
        catch (Exception ex)
        {
     errorMessage = $"��r�����G���[: {ex.Message}";
            Logger.LogError(ex, "��r�����G���[");
        }
        finally
        {
        isLoading = false;
    }
  }

    private async Task SaveTemplate()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(newTemplateName) && selectedTemplateId > 0)
      {
  await UpdateTemplate();
      return;
         }

       if (string.IsNullOrWhiteSpace(newTemplateName))
    {
    templateMessage = "�e���v���[�g������͂��Ă�������";
        return;
      }

    var template = new CellMappingTemplate
    {
      TemplateName = newTemplateName.Trim(),
                Description = newTemplateDescription?.Trim(),
        CreatedAt = DateTime.UtcNow,
          UpdatedAt = DateTime.UtcNow
            };

            var sortOrder = 0;
            foreach (var mapping in cellMappings)
          {
     // �t�@�C�����ƃV�[�g���ŕۑ�
var sheet1Name = $"{mapping.Book1FileName}:{mapping.Sheet1Name}";
        var sheet2Name = $"{mapping.Book2FileName}:{mapping.Sheet2Name}";

  Logger.LogInformation($"�ۑ�: {mapping.ItemName} -> Sheet1={sheet1Name}, Sheet2={sheet2Name}");

             template.MappingItems.Add(new CellMappingItem
   {
              SortOrder = sortOrder++,
          ItemName = mapping.ItemName,
 Sheet1Name = sheet1Name,
     Sheet1Cell = mapping.Sheet1Cell,
         Sheet2Name = sheet2Name,
    Sheet2Cell = mapping.Sheet2Cell
   });
     }

Db.CellMappingTemplates.Add(template);
 await Db.SaveChangesAsync();

  templateMessage = $"�e���v���[�g�u{newTemplateName}�v��ۑ����܂����i{template.MappingItems.Count}���ځj";
      newTemplateName = string.Empty;
     newTemplateDescription = string.Empty;

        await LoadSavedTemplates();
        }
      catch (Exception ex)
    {
    templateMessage = $"�ۑ��G���[: {ex.Message}";
     Logger.LogError(ex, "�e���v���[�g�ۑ��G���[");
    }
    }

    private async Task UpdateTemplate()
    {
    try
    {
            var template = await Db.CellMappingTemplates
     .Include(t => t.MappingItems)
             .FirstOrDefaultAsync(t => t.TemplateId == selectedTemplateId);

 if (template == null)
            {
           templateMessage = "�e���v���[�g��������܂���";
      return;
      }

            if (!string.IsNullOrWhiteSpace(newTemplateDescription))
     {
        template.Description = newTemplateDescription.Trim();
            }

  template.UpdatedAt = DateTime.UtcNow;

            Db.CellMappingItems.RemoveRange(template.MappingItems);

            var sortOrder = 0;
         foreach (var mapping in cellMappings)
      {
           template.MappingItems.Add(new CellMappingItem
       {
         TemplateId = template.TemplateId,
  SortOrder = sortOrder++,
           ItemName = mapping.ItemName,
          Sheet1Name = $"{mapping.Book1FileName}:{mapping.Sheet1Name}",
    Sheet1Cell = mapping.Sheet1Cell,
          Sheet2Name = $"{mapping.Book2FileName}:{mapping.Sheet2Name}",
        Sheet2Cell = mapping.Sheet2Cell
              });
            }

 await Db.SaveChangesAsync();

            templateMessage = $"�e���v���[�g�u{template.TemplateName}�v���㏑���ۑ����܂���";
        newTemplateDescription = string.Empty;

      await LoadSavedTemplates();
        }
  catch (Exception ex)
     {
            templateMessage = $"�㏑���ۑ��G���[: {ex.Message}";
         Logger.LogError(ex, "�e���v���[�g�㏑���ۑ��G���[");
        }
    }

    private async Task LoadTemplate()
    {
        try
        {
         var template = await Db.CellMappingTemplates
                .Include(t => t.MappingItems)
    .FirstOrDefaultAsync(t => t.TemplateId == selectedTemplateId);

            if (template != null)
    {
      Logger.LogInformation($"�e���v���[�g�ǂݍ���: {template.TemplateName} ({template.MappingItems.Count}����)");

         cellMappings = template.MappingItems
     .OrderBy(i => i.SortOrder)
        .Select(i =>
   {
 var parts1 = i.Sheet1Name.Split(':', 2);
                  var parts2 = i.Sheet2Name.Split(':', 2);

     var book1FileName = parts1.Length > 0 ? parts1[0] : "";
     var sheet1Name = parts1.Length > 1 ? parts1[1] : "";
       var book2FileName = parts2.Length > 0 ? parts2[0] : "";
         var sheet2Name = parts2.Length > 1 ? parts2[1] : "";

    Logger.LogInformation($"�ǂݍ���: {i.ItemName} -> Book1={book1FileName}, Sheet1={sheet1Name}, Book2={book2FileName}, Sheet2={sheet2Name}");

      // �t�@�C��������u�b�NIndex������
         var book1Index = uploadedBooks.FindIndex(b => b.FileName == book1FileName);
  var book2Index = uploadedBooks.FindIndex(b => b.FileName == book2FileName);

 return new CellMapping
 {
           ItemName = i.ItemName,
        Book1FileName = book1FileName,
Book1Index = book1Index,
           Sheet1Name = sheet1Name,
           Sheet1Cell = i.Sheet1Cell,
   Book2FileName = book2FileName,
  Book2Index = book2Index,
                  Sheet2Name = sheet2Name,
        Sheet2Cell = i.Sheet2Cell
          };
      })
     .ToList();

      var missingFiles = cellMappings
            .Where(m => m.Book1Index < 0 || m.Book2Index < 0)
        .SelectMany(m => new[] { 
m.Book1Index < 0 ? m.Book1FileName : null, 
                  m.Book2Index < 0 ? m.Book2FileName : null 
        })
         .Where(f => !string.IsNullOrEmpty(f))
    .Distinct()
             .ToList();

       if (missingFiles.Any())
      {
           templateMessage = $"�e���v���[�g�u{template.TemplateName}�v��ǂݍ��݂܂����i{cellMappings.Count}���ځj\n" +
      $"? �ȉ��̃t�@�C����������܂���: {string.Join(", ", missingFiles)}\n" +
  $"�Y���t�@�C�����A�b�v���[�h���邩�A�t�@�C�������C�����Ă��������B";
        }
  else
        {
          templateMessage = $"�e���v���[�g�u{template.TemplateName}�v��ǂݍ��݂܂����i{cellMappings.Count}���ځj";
       }
        }
        }
        catch (Exception ex)
     {
   templateMessage = $"�ǂݍ��݃G���[: {ex.Message}";
            Logger.LogError(ex, "�e���v���[�g�ǂݍ��݃G���[");
        }
    }

    private async Task DeleteTemplate()
    {
    try
     {
     var template = await Db.CellMappingTemplates.FindAsync(selectedTemplateId);
      if (template != null)
      {
       Db.CellMappingTemplates.Remove(template);
await Db.SaveChangesAsync();

            templateMessage = $"�e���v���[�g�u{template.TemplateName}�v���폜���܂���";
     selectedTemplateId = 0;

       await LoadSavedTemplates();
            }
    }
        catch (Exception ex)
        {
         templateMessage = $"�폜�G���[: {ex.Message}";
         Logger.LogError(ex, "�e���v���[�g�폜�G���[");
        }
    }

    private void AddMapping()
    {
        cellMappings.Add(new CellMapping
  {
 Book1Index = -1,
   Book1FileName = "",
          Sheet1Name = "",
  Book2Index = -1,
     Book2FileName = "",
  Sheet2Name = ""
        });
    }

    private void RemoveMapping(int index)
    {
        if (index >= 0 && index < cellMappings.Count)
        {
      cellMappings.RemoveAt(index);
        }
    }

    private void ClearMappings()
    {
        cellMappings.Clear();
    }

    public void Dispose()
    {
        foreach (var book in uploadedBooks)
        {
        book.Workbook?.Dispose();
 }
    }
}
