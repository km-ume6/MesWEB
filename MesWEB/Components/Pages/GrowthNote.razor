@page "/growth-note"
@rendermode InteractiveServer
@implements IDisposable

@using MesWEB.Data
@using MesWEB.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject DeviceDetectionService DeviceService

<PageTitle>育成ノート</PageTitle>

<style>
    /* Bootstrap ボタンスタイル */
    .btn {
        display: inline-block !important;
        font-weight: 400 !important;
        line-height: 1.5 !important;
        color: #212529 !important;
        text-align: center !important;
        text-decoration: none !important;
        vertical-align: middle !important;
        cursor: pointer !important;
        user-select: none !important;
        background-color: transparent !important;
        border: 1px solid transparent !important;
        padding: 0.375rem 0.75rem !important;
        font-size: 1rem !important;
        border-radius: 0.375rem !important;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
    }

    .btn-primary {
        color: #fff !important;
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
    }

        .btn-primary:hover {
            color: #fff !important;
            background-color: #0b5ed7 !important;
            border-color: #0a58ca !important;
        }

    .btn-outline-primary {
        color: #0d6efd !important;
        border-color: #0d6efd !important;
    }

        .btn-outline-primary:hover {
            color: #fff !important;
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
        }

    .btn-success {
        color: #fff !important;
        background-color: #198754 !important;
        border-color: #198754 !important;
    }

        .btn-success:hover {
            color: #fff !important;
            background-color: #157347 !important;
            border-color: #146c43 !important;
        }

    .btn-outline-secondary {
        color: #6c757d !important;
        border-color: #6c757d !important;
    }

        .btn-outline-secondary:hover {
            color: #fff !important;
            background-color: #6c757d !important;
            border-color: #6c757d !important;
        }

    .btn-outline-danger {
        color: #dc3545 !important;
        border-color: #dc3545 !important;
    }

        .btn-outline-danger:hover {
            color: #fff !important;
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
        }

    .btn-sm {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.875rem !important;
        border-radius: 0.25rem !important;
    }

    .btn-xs {
        padding: 0.2rem 0.4rem !important;
        font-size: 0.7rem !important;
        line-height: 1.1 !important;
        min-width: 50px !important;
        border-radius: 0.25rem !important;
        height: 30px !important;
    }

    /* 編集・削除ボタン専用 幅を狭くする */
    .action-btn-narrow {
        min-width: 48px !important;
        width: 60px !important;
        padding-left: 0.2rem !important;
        padding-right: 0.2rem !important;
    }

    .growth-note-table {
        border: 2px solid #333;
        table-layout: auto;
        width: auto;
        max-width: 100%;
    }

        .growth-note-table th,
        .growth-note-table td {
            border: 1px solid #666;
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.85rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .growth-note-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            border: 1px solid #333;
        }

        .growth-note-table .item-label {
            background-color: #e9ecef;
            font-weight: bold;
            text-align: left;
            border-right: 2px solid #333;
            width: 180px;
            min-width: 180px;
        }

        /* データ列の幅制限 - 備考以外 */
        .growth-note-table th:not(.item-label),
        .growth-note-table td:not(.item-label):not(.remarks-cell) {
            width: 120px;
            min-width: 100px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 数値データ列（右詰） */
        .growth-note-table .numeric-data {
            text-align: right !important;
        }

        /* 文字列データ列（左詰） */
        .growth-note-table .text-data {
            text-align: left !important;
        }

        /* 日付データ列（中央揃え） */
        .growth-note-table .date-data {
            text-align: center !important;
        }

        /* 備考列のみ幅を広く */
        .growth-note-table .remarks-cell {
            width: 200px;
            min-width: 180px;
            max-width: 220px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: left !important;
        }

        /* 操作列はボタンに合わせて */
        .growth-note-table .action-cell {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

    /* テーブル容器のスタイル調整 */
    .table-container {
        width: fit-content;
        max-width: 100%;
        margin: 0;
    }

    .filter-compact {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .filter-row {
        display: flex;
        align-items: start;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .filter-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        margin-right: 0.5rem;
    }

    .filter-fields {
        display: flex;
        align-items: end;
        gap: 0.5rem;
        flex-wrap: wrap;
        flex: 1;
    }

    .filter-item {
        min-width: 120px;
        max-width: 180px;
        flex: 1;
    }

        .filter-item label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
            color: #495057;
        }

        .filter-item input,
        .filter-item select {
            font-size: 0.8rem;
            padding: 0.25rem 0.4rem;
            height: 30px;
        }

    .crystal-lot-filter {
        min-width: 120px;
        max-width: 140px;
        flex: 1 1 140px;
        box-sizing: border-box;
    }

        .crystal-lot-filter input {
            width: 100%;
            box-sizing: border-box;
        }
</style>

<h1>育成ノート</h1>

<!-- 超コンパクト絞り込みパネル -->
<div class="filter-compact">
    <div class="filter-row">
        <div class="filter-buttons">
            <button type="button" class="btn btn-success btn-xs" @onclick="ApplyFilter">絞込</button>
            <button type="button" class="btn btn-outline-secondary btn-xs" @onclick="ClearFilter">解除</button>
        </div>
        <div class="filter-fields">
            <div class="filter-item">
                <label>期間（開始）</label>
                <input type="date" @bind="filterStartDate" class="form-control form-control-sm" />
            </div>
            <div class="filter-item">
                <label>期間（終了）</label>
                <input type="date" @bind="filterEndDate" class="form-control form-control-sm" />
            </div>
            <div class="filter-item">
                <label>担当者</label>
                <select @bind="filterOperator" class="form-select form-select-sm">
                    <option value="">全て</option>
                    @foreach (var op in allOperators)
                    {
                        <option value="@op">@op</option>
                    }
                </select>
            </div>
            <div class="filter-item">
                <label>装置名</label>
                <select @bind="filterMachine" class="form-select form-select-sm">
                    <option value="">全て</option>
                    @foreach (var machine in allMachines)
                    {
                        <option value="@machine">@machine</option>
                    }
                </select>
            </div>
            <div class="filter-item">
                <label>添加元素</label>
                <select @bind="filterDopants" class="form-select form-select-sm">
                    <option value="">全て</option>
                    @foreach (var dopant in allDopants)
                    {
                        <option value="@dopant">@dopant</option>
                    }
                </select>
            </div>
            <div class="filter-item crystal-lot-filter">
                <label>結晶ロット</label>
                <input type="text" @bind="filterCrystalLot" class="form-control form-control-sm" placeholder="部分一致" />
            </div>
        </div>
    </div>
    @if (isFiltered)
    {
        <div style="margin-top: 0.3rem; margin-left: 60px;">
            <small class="text-muted">絞込中：全@(totalRecords)件中@(notes?.Count ?? 0)件表示</small>
        </div>
    }
</div>

<div class="mb-3">
    @if (DeviceService.IsDetected)
    {
        <button type="button" class="btn btn-primary" @onclick="NavigateToAdd">
            <i class="fas fa-plus me-2"></i>レコード追加
        </button>
    }
    else
    {
        <button type="button" class="btn btn-primary" disabled>
            <i class="fas fa-spinner fa-spin me-2"></i>読み込み中...
        </button>
    }
    <button type="button" class="btn @(showLatestOnly ? "btn-primary" : "btn-outline-primary") ms-1" @onclick="() => ToggleView(true)">
        装置名ごと最新表示
    </button>
    <button type="button" class="btn @(!showLatestOnly ? "btn-primary" : "btn-outline-primary") ms-2" @onclick="() => ToggleView(false)">
        全件表示
    </button>
</div>

<p>@(showLatestOnly ? "装置名ごと最新一件表示" : "全件表示")</p>

@if (isLoading)
{
    <p>読み込み中...</p>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>エラー:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
    </div>
}

@if (notes is null)
{
    <p>読み込み中...</p>
}
else if (!notes.Any())
{
    <p>データがありません</p>
}
else
{
    <div class="table-responsive">
        <div class="table-container">
            <table class="table table-sm growth-note-table">
                <thead>
                    <tr>
                        <th class="item-label">項目</th>
                        @for (int i = 0; i < notes.Count; i++)
                        {
                            <th>ID: @notes[i].CGNoteId</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="item-label"><strong>操作</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="action-cell">
                                <div class="d-flex flex-row gap-1">
                                    <button type="button" class="btn btn-sm btn-primary action-btn-narrow" @onclick="@(() => NavigateToEdit(n.CGNoteId))">
                                        <i class="fas fa-edit me-1"></i>編集
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger action-btn-narrow" @onclick="@(() => DeleteNote(n.CGNoteId))" @onclick:stopPropagation="true">
                                        <i class="fas fa-trash me-1"></i>削除
                                    </button>
                                </div>
                            </td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>結晶育成日</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="date-data">@(n.CrystalGrowthDate?.ToString("yyyy-MM-dd") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>担当者</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.Operator ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>装置名</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data @(showLatestOnly ? "bg-warning-subtle" : "")">@(n.MachineName ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>添加元素</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.Dopants ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>添加量</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.DopantAmount?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>添加濃度(ppm)</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.ppm?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>結晶ロット</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.CrystalLot ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>ペレット投入量</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.PelletFeed?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>ペレットロット①</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.PelletLot1 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>ペレットロット②</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.PelletLot2 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>ペレットロット③</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.PelletLot3 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>カレット投入量</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.CulletFeed?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>カレットロット①</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.CulletLot1 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>カレットロット②</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.CulletLot2 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>カレットロット③</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.CulletLot3 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>坩堝番号</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.CrucibleName ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>坩堝使用回数</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.CrucibleCount?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>引上げ時間（⊿ｔ）</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.DeltaT?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>坩堝内カオウール</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.InsideInsulationComposition ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>坩堝底カオウール</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.BottomInsulationComposition ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>炉組条件①</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.FurnaceCondition1 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>炉組条件②</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.FurnaceCondition2 ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>リング高さ</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.RingHeightPosition ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>ジルコニア円板</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.UsingDisk ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>育成開始時刻</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="date-data">@(n.GrowthStartTime?.ToString(@"hh\:mm") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>肩育成終了時刻</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="date-data">@(n.ShoulderEndTime?.ToString(@"hh\:mm") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>ネッキング時電源出力</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.NeckingVoltage?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>育成時電源出力</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.GrowthVoltage?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>シード位置</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.SeedHeightPosition?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>初期引上げ速度</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.StartPullingSpeed?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>肩育成引上げ速度</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.ShoulderEndPullingSpeed?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>直胴部引上げ速度</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.LastPullingSpeed?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>初期シード回転数</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.FirstRotationalSpeed?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>肩育シード成回転数</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.ShoulderEndRotationalSpeed?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>直胴部シード回転数</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.LastRotationalSpeed?.ToString("F2") ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>ワークコイル重心位置</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.GravityCenterWC ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>育成時ワークコイル位置</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.HeightPositionWC ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>結晶ヘッド径</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.HeadDiameter?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>結晶テール径</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.TailDiameter?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>電源出力電圧</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.OutputVoltage?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>電源出力電流</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="numeric-data">@(n.OutputCurrent?.ToString() ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>液面高さ</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="text-data">@(n.LiquidLevel ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>備考</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="remarks-cell">@(n.Remarks ?? "-")</td>
                        }
                    </tr>
                    <tr>
                        <td class="item-label"><strong>作成日時</strong></td>
                        @foreach (var n in notes)
                        {
                            <td class="date-data">@n.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        }
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div style="margin-top: 1.5rem; text-align: right;">
        <p>アクセス数: @accessCount</p>
    </div>
}

@code {
    private List<GrowthNoteItem>? notes;
    private bool showLatestOnly = true; // デフォルトは装置名ごと最新表示
    private bool isFiltered = false;
    private int totalRecords = 0;
    private int accessCount = 0;
    private bool hasCountedAccess = false; // アクセスカウンター実行フラグ
    private bool isLoading = true; // ローディング状態
    private string errorMessage = string.Empty; // エラーメッセージ

    // 絞込条件
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private string? filterOperator = null;
    private string? filterMachine = null;
    private string? filterDopants = null;
    private string filterCrystalLot = "";

    // 絞込用選択肢
    private List<string> allOperators = new();
    private List<string> allMachines = new();
    private List<string> allDopants = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
      errorMessage = string.Empty;
        
        try
    {
       // アクセスカウンターは1回だけ実行
          if (!hasCountedAccess)
      {
    await IncrementAndGetAccessCount();
                hasCountedAccess = true;
       }
            
   await LoadFilterOptions();
await LoadNotes();

            // DeviceServiceのイベントにサブスクライブ
     DeviceService.DeviceDetected += OnDeviceDetected;
      }
        catch (Exception ex)
  {
          // エラーメッセージをユーザーに表示
 errorMessage = $"データの読み込みに失敗しました: {ex.Message}";
        
 // エラー時も空のリストを表示
            notes = new List<GrowthNoteItem>();
        }
     finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DeviceService.DetectDeviceAsync(JSRuntime);
            StateHasChanged(); // UIを更新
        }
    }

    public void Dispose()
    {
        // イベントのサブスクライブを解除
        DeviceService.DeviceDetected -= OnDeviceDetected;
    }

    private void OnDeviceDetected()
    {
        StateHasChanged(); // デバイス判定完了時にUIを更新
    }

    private void NavigateToAdd()
    {
        if (!DeviceService.IsDetected)
        {
            return;
        }

        var targetUrl = DeviceService.IsAndroid ? "/growth-note/add/android" : "/growth-note/add";

        try
        {
            Navigation.NavigateTo(targetUrl, forceLoad: true);
        }
        catch (Exception)
        {
            // エラーハンドリング
        }
    }

    private void NavigateToEdit(int id)
    {
        if (!DeviceService.IsDetected)
        {
            return;
        }

        var targetUrl = DeviceService.IsAndroid ? $"/growth-note/edit/{id}/android" : $"/growth-note/edit/{id}";

        try
        {
            Navigation.NavigateTo(targetUrl, forceLoad: true);
        }
        catch (Exception)
        {
            // エラーハンドリング
        }
    }

    private async Task LoadFilterOptions()
    {
        try
        {
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30)); // タイムアウトを30秒に延長
            await using var db = await DbFactory.CreateDbContextAsync(cts.Token);
         
    var allNotes = await db.GrowthNotes.AsNoTracking().ToListAsync(cts.Token);
   totalRecords = allNotes.Count;

    allOperators = allNotes.Where(n => !string.IsNullOrWhiteSpace(n.Operator))
        .Select(n => n.Operator!).Distinct().OrderBy(x => x).ToList();

      allMachines = allNotes.Where(n => !string.IsNullOrWhiteSpace(n.MachineName))
       .Select(n => n.MachineName!).Distinct().OrderBy(x => x).ToList();

      allDopants = allNotes.Where(n => !string.IsNullOrWhiteSpace(n.Dopants))
  .Select(n => n.Dopants!).Distinct().OrderBy(x => x).ToList();
      }
        catch (TaskCanceledException)
        {
      errorMessage = "フィルターオプションの読み込みがタイムアウトしました。";
    allOperators = new List<string>();
       allMachines = new List<string>();
          allDopants = new List<string>();
    totalRecords = 0;
        }
        catch (Exception ex)
        {
      errorMessage = $"フィルターオプションの読み込みエラー: {ex.Message}";
            allOperators = new List<string>();
       allMachines = new List<string>();
      allDopants = new List<string>();
    totalRecords = 0;
        }
    }

    private async Task LoadNotes()
    {
        try
 {
          using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30)); // タイムアウトを30秒に延長
            await using var db = await DbFactory.CreateDbContextAsync(cts.Token);
         
   var query = db.GrowthNotes.AsQueryable();

     // 絞込条件の適用
     if (isFiltered)
          {
  if (filterStartDate.HasValue)
  {
 query = query.Where(n => n.CrystalGrowthDate >= filterStartDate.Value);
        }

      if (filterEndDate.HasValue)
     {
         query = query.Where(n => n.CrystalGrowthDate <= filterEndDate.Value);
 }

     if (!string.IsNullOrWhiteSpace(filterOperator))
 {
         query = query.Where(n => n.Operator == filterOperator);
     }

       if (!string.IsNullOrWhiteSpace(filterMachine))
       {
      query = query.Where(n => n.MachineName == filterMachine);
      }

   if (!string.IsNullOrWhiteSpace(filterDopants))
     {
      query = query.Where(n => n.Dopants == filterDopants);
            }

           if (!string.IsNullOrWhiteSpace(filterCrystalLot))
     {
    query = query.Where(n => n.CrystalLot != null && n.CrystalLot.Contains(filterCrystalLot));
    }
     }

       var filteredNotes = await query.AsNoTracking().ToListAsync(cts.Token);

    // 絞込み中は常に全件表示、絞込み解除時のみ最新表示の設定を適用
      if (showLatestOnly && !isFiltered)
       {
         // 装置名ごとに最新一件のみを取得
     notes = filteredNotes
  .Where(n => !string.IsNullOrWhiteSpace(n.MachineName))
             .GroupBy(n => n.MachineName)
     .Select(g => g.OrderByDescending(n => n.CrystalGrowthDate ?? DateTime.MinValue)
    .ThenByDescending(n => n.CreatedAt)
            .First())
     .OrderBy(n => n.MachineName)
  .ToList();
          }
         else
    {
   // 全件表示
 notes = filteredNotes.OrderByDescending(n => n.CrystalGrowthDate).ToList();
  }
          
          errorMessage = string.Empty; // 成功時はエラーメッセージをクリア
   }
        catch (TaskCanceledException)
        {
   errorMessage = "データの読み込みがタイムアウトしました。データベース接続を確認してください。";
    notes = new List<GrowthNoteItem>();
    }
        catch (Exception ex)
      {
   errorMessage = $"データベースエラー: {ex.Message}";
          notes = new List<GrowthNoteItem>();
   }
    }

    private async Task ToggleView(bool latestOnly)
    {
        showLatestOnly = latestOnly;
        await LoadNotes();
        StateHasChanged();
    }

    private async Task ApplyFilter()
    {
        isFiltered = true;
        await LoadNotes();
        StateHasChanged();
    }

    private async Task ClearFilter()
    {
        isFiltered = false;
        filterStartDate = null;
        filterEndDate = null;
        filterOperator = null;
        filterMachine = null;
        filterDopants = null;
        filterCrystalLot = "";
        await LoadNotes();
        StateHasChanged();
    }

    private async Task DeleteNote(int id)
    {
        // 確認ダイアログを表示
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"ID: {id} のレコードを削除しますか？");
        if (!confirmed)
            return;

   await using var db = await DbFactory.CreateDbContextAsync();
        var note = await db.GrowthNotes.FindAsync(id);
        if (note != null)
        {
   db.GrowthNotes.Remove(note);
       await db.SaveChangesAsync();

    // 再読み込み
            await LoadNotes();
     await LoadFilterOptions();
        }
    }

    private async Task IncrementAndGetAccessCount()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        const string pageName = "GrowthNote";
        var counter = await db.PageAccessCounters.FindAsync(pageName);
        if (counter == null)
        {
            counter = new PageAccessCounter { PageName = pageName, Count = 1 };
          db.PageAccessCounters.Add(counter);
 }
        else
        {
       counter.Count++;
          db.PageAccessCounters.Update(counter);
        }
  await db.SaveChangesAsync();
        accessCount = counter.Count;
    }
}